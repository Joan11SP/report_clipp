/**
 * Minified by jsDelivr using Terser v5.7.1.
 * Original file: /npm/node-fetch@3.0.0/src/index.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import http from"http";import https from"https";import zlib from"zlib";import Stream,{PassThrough,pipeline as pump}from"stream";import dataUriToBuffer from"data-uri-to-buffer";import{writeToStream}from"./body.js";import Response from"./response.js";import Headers,{fromRawHeaders}from"./headers.js";import Request,{getNodeRequestOptions}from"./request.js";import{FetchError}from"./errors/fetch-error.js";import{AbortError}from"./errors/abort-error.js";import{isRedirect}from"./utils/is-redirect.js";export{Headers,Request,Response,FetchError,AbortError,isRedirect};const supportedSchemas=new Set(["data:","http:","https:"]);export default async function fetch(e,r){return new Promise(((t,o)=>{const s=new Request(e,r),n=getNodeRequestOptions(s);if(!supportedSchemas.has(n.protocol))throw new TypeError(`node-fetch cannot load ${e}. URL scheme "${n.protocol.replace(/:$/,"")}" is not supported.`);if("data:"===n.protocol){const e=dataUriToBuffer(s.url),r=new Response(e,{headers:{"Content-Type":e.typeFull}});return void t(r)}const a=("https:"===n.protocol?https:http).request,{signal:i}=s;let d=null;const c=()=>{const e=new AbortError("The operation was aborted.");o(e),s.body&&s.body instanceof Stream.Readable&&s.body.destroy(e),d&&d.body&&d.body.emit("error",e)};if(i&&i.aborted)return void c();const u=()=>{c(),l()},p=a(n);i&&i.addEventListener("abort",u);const l=()=>{p.abort(),i&&i.removeEventListener("abort",u)};p.on("error",(e=>{o(new FetchError(`request to ${s.url} failed, reason: ${e.message}`,"system",e)),l()})),fixResponseChunkedTransferBadEnding(p,(e=>{d.body.destroy(e)})),process.version<"v14"&&p.on("socket",(e=>{let r;e.prependListener("end",(()=>{r=e._eventsCount})),e.prependListener("close",(t=>{if(d&&r<e._eventsCount&&!t){const e=new Error("Premature close");e.code="ERR_STREAM_PREMATURE_CLOSE",d.body.emit("error",e)}}))})),p.on("response",(e=>{p.setTimeout(0);const n=fromRawHeaders(e.rawHeaders);if(isRedirect(e.statusCode)){const a=n.get("Location"),i=null===a?null:new URL(a,s.url);switch(s.redirect){case"error":return o(new FetchError(`uri requested responds with a redirect, redirect mode is set to error: ${s.url}`,"no-redirect")),void l();case"manual":null!==i&&n.set("Location",i);break;case"follow":{if(null===i)break;if(s.counter>=s.follow)return o(new FetchError(`maximum redirect reached at: ${s.url}`,"max-redirect")),void l();const n={headers:new Headers(s.headers),follow:s.follow,counter:s.counter+1,agent:s.agent,compress:s.compress,method:s.method,body:s.body,signal:s.signal,size:s.size};return 303!==e.statusCode&&s.body&&r.body instanceof Stream.Readable?(o(new FetchError("Cannot follow redirect with body being a readable stream","unsupported-redirect")),void l()):(303!==e.statusCode&&(301!==e.statusCode&&302!==e.statusCode||"POST"!==s.method)||(n.method="GET",n.body=void 0,n.headers.delete("content-length")),t(fetch(new Request(i,n))),void l())}default:return o(new TypeError(`Redirect option '${s.redirect}' is not a valid value of RequestRedirect`))}}i&&e.once("end",(()=>{i.removeEventListener("abort",u)}));let a=pump(e,new PassThrough,o);process.version<"v12.10"&&e.on("aborted",u);const c={url:s.url,status:e.statusCode,statusText:e.statusMessage,headers:n,size:s.size,counter:s.counter,highWaterMark:s.highWaterMark},m=n.get("Content-Encoding");if(!s.compress||"HEAD"===s.method||null===m||204===e.statusCode||304===e.statusCode)return d=new Response(a,c),void t(d);const f={flush:zlib.Z_SYNC_FLUSH,finishFlush:zlib.Z_SYNC_FLUSH};if("gzip"===m||"x-gzip"===m)return a=pump(a,zlib.createGunzip(f),o),d=new Response(a,c),void t(d);if("deflate"!==m&&"x-deflate"!==m){if("br"===m)return a=pump(a,zlib.createBrotliDecompress(),o),d=new Response(a,c),void t(d);d=new Response(a,c),t(d)}else{pump(e,new PassThrough,o).once("data",(e=>{a=8==(15&e[0])?pump(a,zlib.createInflate(),o):pump(a,zlib.createInflateRaw(),o),d=new Response(a,c),t(d)}))}})),writeToStream(p,s)}))}function fixResponseChunkedTransferBadEnding(e,r){const t=Buffer.from("0\r\n\r\n");let o,s=!1,n=!1;e.on("response",(e=>{const{headers:r}=e;s="chunked"===r["transfer-encoding"]&&!r["content-length"]})),e.on("socket",(a=>{const i=()=>{if(s&&!n){const e=new Error("Premature close");e.code="ERR_STREAM_PREMATURE_CLOSE",r(e)}};a.prependListener("close",i),e.on("abort",(()=>{a.removeListener("close",i)})),a.on("data",(e=>{n=0===Buffer.compare(e.slice(-5),t),!n&&o&&(n=0===Buffer.compare(o.slice(-3),t.slice(0,3))&&0===Buffer.compare(e.slice(-2),t.slice(3))),o=e}))}))}
//# sourceMappingURL=/sm/9a9b4dcae9b3861f93203e2653922fd2f2ec33df8b6ecccfaa5a3dbf5aaf2b75.map